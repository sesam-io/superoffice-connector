[
  {
    "_id": "{{@ system @}}-{{@ datatype @}}-all",
    "namespaced_identifiers": false,
    "source": {
      "dataset": "{{@ system @}}-{{@ parent @}}-collect",
      "type": "dataset"
    },
    "transform": {
      "rules": {
        "create_versions": [
          [
            "copy",
            "*"
          ],
          [
            "add",
            "sesam_SaleId",
            "_R._S.sesam_SaleId"
          ],
          [
            "add",
            "_id",
            [
              "string",
              "_S.QuoteAlternativeId"
            ]
          ],
          [
            "add",
            "$original_id",
            "_R._S._id"
          ],
          [
            "add",
            "$last-modified",
            "_R._S.$last-modified"
          ]
        ],
        "default": [
          [
            "create-child",
            [
              "apply",
              "create_versions",
              "_S.QuoteAlternatives"
            ]
          ]
        ]
      },
      "type": "dtl"
    },
    "type": "pipe"
  },
  {
    "_id": "{{@ system @}}-{{@ datatype @}}-all2",
    "namespaced_identifiers": false,
    "source": {
      "dataset": "{{@ system @}}-{{@ datatype @}}-all",
      "type": "dataset"
    },
    "transform": {
      "type": "emit_children"
    },
    "type": "pipe"
  },
  {
    "_id": "{{@ system @}}-{{@ datatype @}}-collect",
    "exclude_completeness": [
      "{{@ system @}}-{{@ datatype @}}quote-share",
      "{{@ system @}}-{{@ datatype @}}-share"
    ],
    "namespaced_identifiers": false,
    "source": {
      "dataset": "{{@ system @}}-{{@ datatype @}}-all2",
      "type": "dataset"
    },
    "transform": {
      "transforms": [
        {
          "operation": "{{@ datatype @}}sale-lookup",
          "side_effects": false,
          "system": "{{@ system @}}",
          "type": "rest"
        },
        {
          "rules": {
            "default": [
              [
                "comment",
                "Now that updates are updates instead of inserts this can probably be removed. Leaving for now because it doesn't hurt to have it included."
              ],
              [
                "copy",
                "*"
              ],
              [
                "if",
                [
                  "eq",
                  "_S.QuoteAlternativeId",
                  "_S.response.AcceptedQuoteAlternativeId"
                ],
                [
                  "add",
                  "sesam_Accepted",
                  true
                ],
                [
                  "add",
                  "sesam_Accepted",
                  false
                ]
              ],
              [
                "remove",
                "response"
              ]
            ]
          },
          "type": "dtl"
        },
        {
          "allowed_status_codes": "200,403",
          "operation": "{{@ datatype @}}-lookup",
          "replace_entity": false,
          "response_property": "response_body",
          "response_status_property": "response_status",
          "side_effects": false,
          "system": "{{@ system @}}",
          "type": "rest"
        },
        {
          "rules": {
            "default": [
              [
                "case-eq",
                "_S.response_status",
                200,
                [
                  [
                    "merge",
                    [
                      "first",
                      "_S.response_body"
                    ]
                  ],
                  [
                    "if",
                    [
                      "eq",
                      "_S._deleted",
                      true
                    ],
                    [
                      "add",
                      "_deleted",
                      false
                    ]
                  ]
                ],
                404,
                [
                  [
                    "if",
                    [
                      "eq",
                      "_S._deleted",
                      true
                    ],
                    [
                      "copy",
                      "*",
                      [
                        "list",
                        "response_body",
                        "response_status"
                      ]
                    ],
                    [
                      "discard"
                    ]
                  ]
                ]
              ],
              [
                "add",
                "_id",
                [
                  "string",
                  "_T.QuoteAlternativeId"
                ]
              ],
              [
                "comment",
                "TODO: Why do we need sesam_SaleId when it's already part of the quote."
              ],
              [
                "copy",
                [
                  "list",
                  "sesam_SaleId",
                  "sesam_Accepted"
                ]
              ]
            ]
          },
          "type": "dtl"
        },
        {
          "rules": {
            "default": [
              [
                "copy",
                "*"
              ],
              [
                "add",
                "_origin_entity",
                [
                  "coalesce",
                  [
                    "is-not-empty",
                    "_."
                  ],
                  [
                    "list",
                    [
                      "first",
                      [
                        "hops",
                        {
                          "datasets": [
                            "{{@ system @}}-{{@ datatype @}}-share st"
                          ],
                          "track-dependencies": false,
                          "where": [
                            [
                              "eq",
                              "_S.QuoteAlternativeId",
                              "st.$generated_id"
                            ]
                          ]
                        }
                      ]
                    ],
                    [
                      "first",
                      [
                        "hops",
                        {
                          "datasets": [
                            "{{@ system @}}-{{@ datatype @}}quote-share st"
                          ],
                          "track-dependencies": false,
                          "where": [
                            [
                              "eq",
                              "_S.QuoteAlternativeId",
                              "st.$trace_insert.response_body.QuoteVersions.QuoteAlternatives.QuoteAlternativeId"
                            ]
                          ]
                        }
                      ]
                    ]
                  ]
                ]
              ],
              [
                "add-if",
                "$origin",
                "_T._origin_entity.$origin"
              ],
              [
                "remove",
                "_origin_entity"
              ],
              [
                "add-if",
                "$truncation",
                [
                  "max",
                  "_._updated",
                  [
                    "hops",
                    {
                      "datasets": [
                        "{{@ system @}}-{{@ datatype @}}-share st"
                      ],
                      "return": "st.$truncation",
                      "track-dependencies": false,
                      "where": [
                        [
                          "eq",
                          "_S.QuoteAlternativeId",
                          "st.QuoteAlternativeId"
                        ]
                      ]
                    }
                  ]
                ]
              ]
            ]
          },
          "type": "dtl"
        }
      ],
      "type": "chained"
    },
    "type": "pipe"
  },
  {
    "_id": "{{@ system @}}-{{@ datatype @}}-share",
    "add_namespaces": false,
    "batch_size": 1,
    "compaction": {
      "keep_versions": 100
    },
    "namespaced_identifiers": false,
    "sink": {
      "deletion_tracking": false,
      "set_initial_offset": "onload"
    },
    "source": {
      "dataset": "{{@ system @}}-{{@ datatype @}}-transform",
      "type": "dataset"
    },
    "transform": [
      {
        "rules": {
          "default": [
            [
              "copy",
              "*"
            ],
            [
              "add-if",
              "SaleId",
              [
                "coalesce",
                [
                  "list",
                  "_S.sesam_SaleId",
                  [
                    "first",
                    [
                      "hops",
                      {
                        "datasets": [
                          "{{@ system @}}-{{@ datatype @}}sale-share ss"
                        ],
                        "return": "ss.$generated_id",
                        "where": [
                          [
                            "eq",
                            "_S.$ids",
                            "ss.$ids"
                          ]
                        ]
                      }
                    ]
                  ]
                ]
              ]
            ],
            [
              "if",
              [
                "not",
                "_S.sesam_Accepted"
              ],
              [
                "if",
                [
                  "is-not-empty",
                  "_T.SaleId"
                ],
                [
                  "add",
                  "$discard",
                  "already inserted"
                ]
              ],
              [
                "if",
                [
                  "is-not-empty",
                  "_T.SaleId"
                ],
                [
                  [
                    "add-if",
                    "_QuoteId",
                    [
                      "first",
                      [
                        "hops",
                        {
                          "datasets": [
                            "{{@ system @}}-quote-collect qc"
                          ],
                          "return": "qc.QuoteId",
                          "where": [
                            [
                              "eq",
                              "_S.sesam_SaleId",
                              "qc.sesam_SaleId"
                            ]
                          ]
                        }
                      ]
                    ]
                  ],
                  [
                    "if",
                    [
                      "is-not-empty",
                      "_T._QuoteId"
                    ],
                    [
                      "if",
                      [
                        "not",
                        [
                          "in",
                          "superoffice-{{@ datatype @}}",
                          [
                            "ni-ns",
                            "_S._id"
                          ]
                        ]
                      ],
                      [
                        "add",
                        "$discard",
                        "wrong entity type for updates"
                      ],
                      [
                        [
                          "add",
                          "$operation",
                          "lookup-quote"
                        ],
                        [
                          "add",
                          "payload",
                          [
                            "dict",
                            "QuoteId",
                            "_T._QuoteId"
                          ]
                        ]
                      ]
                    ],
                    [
                      "add",
                      "$discard",
                      "missing QuoteId"
                    ]
                  ]
                ],
                [
                  "add",
                  "payload",
                  "_S."
                ]
              ]
            ]
          ]
        },
        "type": "dtl"
      },
      {
        "properties": {
          "operation": "{{@ datatype @}}-default",
          "primary_key": "QuoteAlternativeId",
          "rest_system": "{{@ system @}}"
        },
        "template": "transform-defaults-rest",
        "type": "template"
      },
      {
        "properties": {
          "operation_delete_properties": {
            "base_url": "QuoteAlternative",
            "lookup_id": "QuoteAlternativeId"
          },
          "operation_insert_properties": {
            "base_url": "QuoteAlternative"
          },
          "operation_lookup": "{{@ datatype @}}-lookup",
          "operation_update": "{{@ datatype @}}-save",
          "operation_update_properties": {
            "base_url": "QuoteAlternative",
            "lookup_id": "QuoteAlternativeId"
          },
          "primary_key": "QuoteAlternativeId",
          "rest_system": "{{@ system @}}",
          "share_dataset": "{{@ system @}}-{{@ datatype @}}-share"
        },
        "template": "transform-share-rest",
        "type": "template"
      }
    ],
    "type": "pipe"
  }
]
