[
  {
    "_id": "{{@ system @}}-{{@ datatype @}}-all",
    "namespaced_identifiers": false,
    "source": {
      "dataset": "{{@ system @}}-{{@ parent @}}-collect",
      "type": "dataset"
    },
    "transform": {
      "rules": {
        "create_versions": [
          [
            "copy",
            "*"
          ],
          [
            "add",
            "$sale_id",
            "_R._S.$sale_id"
          ],
          [
            "add",
            "_id",
            [
              "string",
              "_S.QuoteAlternativeId"
            ]
          ],
          [
            "add",
            "$original_id",
            "_R._S._id"
          ],
          [
            "add",
            "$last-modified",
            "_R._S.$last-modified"
          ]
        ],
        "default": [
          [
            "create-child",
            [
              "apply",
              "create_versions",
              "_S.QuoteAlternatives"
            ]
          ]
        ]
      },
      "type": "dtl"
    },
    "type": "pipe"
  },
  {
    "_id": "{{@ system @}}-{{@ datatype @}}-all2",
    "namespaced_identifiers": false,
    "source": {
      "dataset": "{{@ system @}}-{{@ datatype @}}-all",
      "type": "dataset"
    },
    "transform": {
      "type": "emit_children"
    },
    "type": "pipe"
  },
  {
    "_id": "{{@ system @}}-{{@ datatype @}}-collect",
    "exclude_completeness": [
      "{{@ system @}}-{{@ datatype @}}-share"
    ],
    "namespaced_identifiers": false,
    "source": {
      "dataset": "{{@ system @}}-{{@ datatype @}}-all2",
      "type": "dataset"
    },
    "transform": {
      "properties": {
        "primary_key": "QuoteAlternativeId",
        "share_dataset": "{{@ system @}}-{{@ datatype @}}-share"
      },
      "template": "transform-collect-rest",
      "type": "template"
    },
    "type": "pipe"
  },
  {
    "_id": "{{@ system @}}-{{@ datatype @}}-share",
    "add_namespaces": false,
    "batch_size": 1,
    "compaction": {
      "keep_versions": 100
    },
    "exclude_completeness": [
      "{{@ system @}}-{{@ datatype @}}-share"
    ],
    "namespaced_identifiers": false,
    "sink": {
      "dataset": "{{@ system @}}-{{@ datatype @}}-share",
      "set-initial-offset": "onload",
      "type": "dataset"
    },
    "source": {
      "dataset": "{{@ system @}}-{{@ datatype @}}-transform",
      "type": "dataset"
    },
    "transform": [
      {
        "transforms": [
          {
            "rules": {
              "default": [
                [
                  "copy",
                  "*"
                ],
                [
                  "comment",
                  "Rename necessary because jinja can't handle $"
                ],
                [
                  "rename",
                  "$sale_id",
                  "sale_id"
                ]
              ]
            },
            "type": "dtl"
          },
          {
            "operation": "{{@ datatype @}}-sale-lookup",
            "operations": {
              "{{@ datatype @}}-sale-lookup": {
                "method": "POST",
                "url": "Agents/Quote/GetQuoteFromSaleId"
              }
            },
            "payload": {
              "SaleId": "{{ entity.sale_id }}"
            },
            "side_effects": false,
            "system": "{{@ system @}}",
            "trace": true,
            "type": "rest"
          },
          {
            "rules": {
              "default": [
                [
                  "copy",
                  "*"
                ],
                [
                  "comment",
                  "See if the sale_id has a corresponding quote or not. If there isn't then one needs to be created. If there is, move on to checking the quote version"
                ],
                [
                  "if",
                  [
                    "is-empty",
                    "_S.response"
                  ],
                  [
                    "merge",
                    [
                      "apply",
                      "no-quote",
                      "_S."
                    ]
                  ]
                ]
              ],
              "no-quote": [
                [
                  "add",
                  "$operation",
                  "create-quote"
                ]
              ]
            },
            "type": "dtl"
          },
          {
            "operation": "{{@ datatype @}}-create-quote",
            "operations": {
              "{{@ datatype @}}-create-quote": {
                "method": "POST",
                "url": "Agents/Quote/CreateAndSaveQuote"
              }
            },
            "payload": {
              "ConnectionId": 1,
              "SaleId": "{{ entity.sale_id }}"
            },
            "system": "{{@ system @}}",
            "trace": true,
            "trigger_on": {
              "key": "$operation",
              "value": "create-quote"
            },
            "type": "rest"
          },
          {
            "rules": {
              "default": [
                [
                  "copy",
                  "*"
                ],
                [
                  "comment",
                  "At this point there should be a quote entity in response. Need to pull ActiveQuoteVersionId out of response in order to be accessible by the jinja 'entity'"
                ],
                [
                  "add",
                  "sesam_ActiveQuoteVersionId",
                  [
                    "first",
                    "_S.response.ActiveQuoteVersionId"
                  ]
                ]
              ]
            },
            "type": "dtl"
          },
          {
            "operation": "{{@ datatype @}}-version-lookup",
            "operations": {
              "{{@ datatype @}}-version-lookup": {
                "method": "POST",
                "url": "Agents/Quote/GetQuoteVersion"
              }
            },
            "payload": {
              "QuoteVersionId": "{{ entity.sesam_ActiveQuoteVersionId }}"
            },
            "system": "{{@ system @}}",
            "trace": true,
            "type": "rest"
          },
          {
            "rules": {
              "default": [
                [
                  "copy",
                  "*"
                ],
                [
                  "comment",
                  "If the quote version is locked then we need a new one, otherwise mopve on to process the quote alternative"
                ],
                [
                  "if",
                  [
                    "neq",
                    "_S.response.State",
                    "Draft"
                  ],
                  [
                    "merge",
                    [
                      "apply",
                      "version-is-locked",
                      "_S."
                    ]
                  ]
                ]
              ],
              "version-is-locked": [
                [
                  "add",
                  "$operation",
                  "create-quote-version"
                ]
              ]
            },
            "type": "dtl"
          },
          {
            "operation": "{{@ datatype @}}-create-version",
            "operations": {
              "{{@ datatype @}}-create-version": {
                "method": "POST",
                "url": "Agents/Quote/CreateAndSaveQuoteVersion"
              }
            },
            "payload": {
              "QuoteVersionId": "{{ entity.sesam_ActiveQuoteVersionId|int }}"
            },
            "system": "{{@ system @}}",
            "trace": true,
            "trigger_on": {
              "key": "$operation",
              "value": "create-quote-version"
            },
            "type": "rest"
          }
        ],
        "type": "chained"
      }
    ],
    "type": "pipe"
  }
]