[
  {
    "_id": "{{@ system @}}-{{@ datatype @}}-preshare",
    "namespaced_identifiers": false,
    "sink": {
      "set-initial-offset": "onload"
    },
    "source": {
      "dataset": "{{@ system @}}-quotealternative-transform",
      "type": "dataset"
    },
    "transform": [
      {
        "rules": {
          "default": [
            [
              "copy",
              "*"
            ],
            [
              "comment",
              "instead of making 2 hops, maybe fix connector to accomodate 2 sources?"
            ],
            [
              "if",
              [
                "is-empty",
                "_S.QuoteVersionId"
              ],
              [
                "add",
                "$discard",
                "Missing QuoteVersionId"
              ],
              [
                [
                  "add",
                  "$operation",
                  "lookup-quoteversion"
                ],
                [
                  "add",
                  "payload",
                  [
                    "dict",
                    "QuoteVersionId",
                    "_T.QuoteVersionId"
                  ]
                ]
              ]
            ]
          ]
        },
        "type": "dtl"
      },
      {
        "operation": "quoteversion-lookup",
        "response_property": "$trace-pre-lookup-quoteversion",
        "side_effects": false,
        "system": "{{@ system @}}",
        "trace": true,
        "trigger_on": {
          "key": "$operation",
          "value": "lookup-quoteversion"
        },
        "type": "rest"
      },
      {
        "rules": {
          "default": [
            [
              "copy",
              "*",
              "payload"
            ],
            [
              "add",
              "State",
              [
                "first",
                "_S.$trace-pre-lookup-quoteversion.State"
              ]
            ],
            [
              "if",
              "_S.sesam_Accepted",
              [
                "if",
                [
                  "eq",
                  "_S.$trace-pre-lookup-quoteversion.State",
                  "Draft"
                ],
                [
                  "add",
                  "$operation",
                  "lookup-quotelines"
                ],
                [
                  "add",
                  "$discard",
                  "QuoteVersion is open/Draft"
                ]
              ],
              [
                "add",
                "$discard",
                "No sesam_Accepted"
              ]
            ]
          ]
        },
        "type": "dtl"
      },
      {
        "operation": "quoteline-list",
        "response_property": "$trace-pre-lookup-quotelines",
        "side_effects": false,
        "system": "{{@ system @}}",
        "trigger_on": {
          "key": "$operation",
          "value": "lookup-quotelines"
        },
        "type": "rest"
      },
      {
        "rules": {
          "default": [
            [
              "if",
              [
                "and",
                [
                  "eq",
                  "_S.$operation",
                  "lookup-quotelines"
                ],
                [
                  "is-not-empty",
                  "_S.$trace-pre-lookup-quotelines"
                ]
              ],
              [
                [
                  "copy",
                  "$ids"
                ],
                [
                  "add",
                  "QuoteVersionId",
                  [
                    "first",
                    "_S.$trace-pre-lookup-quoteversion.QuoteVersionId"
                  ]
                ],
                [
                  "add",
                  "State",
                  "Sold"
                ],
                [
                  "add",
                  "$based_on",
                  [
                    "dict",
                    "State",
                    "Draft"
                  ]
                ],
                [
                  "add",
                  "$based_on_properties",
                  [
                    "list",
                    "State"
                  ]
                ],
                [
                  "add",
                  "$payload",
                  [
                    "dict",
                    "QuoteVersion",
                    [
                      "dict",
                      "QuoteId",
                      [
                        "first",
                        "_S.$trace-pre-lookup-quoteversion.QuoteId"
                      ],
                      "QuoteVersionId",
                      [
                        "first",
                        "_S.$trace-pre-lookup-quoteversion.QuoteVersionId"
                      ],
                      "State",
                      "Sold"
                    ]
                  ]
                ]
              ],
              [
                "add",
                "$discard",
                "no quotelines registered"
              ]
            ]
          ]
        },
        "type": "dtl"
      }
    ],
    "type": "pipe"
  },
  {
    "_id": "{{@ system @}}-{{@ datatype @}}-share",
    "add_namespaces": false,
    "batch_size": 1,
    "compaction": {
      "keep_versions": 100
    },
    "exclude_completeness": [
      "{{@ system @}}-{{@ datatype @}}-share"
    ],
    "namespaced_identifiers": false,
    "sink": {
      "deletion_tracking": false,
      "set_initial_offset": "onload"
    },
    "source": {
      "dataset": "{{@ system @}}-{{@ datatype @}}-preshare",
      "type": "dataset"
    },
    "transform": {
      "properties": {
        "operation_lookup": "quoteversion-lookup",
        "operation_update": "update-quoteversion",
        "primary_key": "QuoteVersionId",
        "rest_system": "{{@ system @}}",
        "share_dataset": "{{@ system @}}-{{@ datatype @}}-share"
      },
      "template": "transform-share-rest",
      "type": "template"
    },
    "type": "pipe"
  }
]