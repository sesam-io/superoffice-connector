[
  {
    "_id": "{{@ system @}}-{{@ datatype @}}-all",
    "metadata": {
      "supports_since": true
    },
    "namespaced_identifiers": false,
    "source": {
      "operation": "list",
      "properties": {
        "base_url": "{{@ base_url @}}",
        "primary_key": "{{@ datatype @}}Id",
        "updated_param": "{{@ updated_param @}}"
      },
      "since_property_location": "manual",
      "since_property_name": "since",
      "supports_since": true,
      "system": "{{@ system @}}",
      "type": "rest",
      "updated_expression": "{{ {{@ updated_param @}} }}"
    },
    "type": "pipe"
  },
  {
    "_id": "{{@ system @}}-{{@ datatype @}}-collect",
    "exclude_completeness": [
      "{{@ system @}}-{{@ datatype @}}-share"
    ],
    "namespaced_identifiers": false,
    "source": {
      "dataset": "{{@ system @}}-{{@ datatype @}}-all",
      "type": "dataset"
    },
    "transform": [
      {
        "properties": {
          "operation_lookup": "lookup-from-list",
          "operation_lookup_properties": {
            "base_url": "{{@ base_url @}}",
            "list_id": "{{@ datatype @}}Id",
            "primary_key": "{{@ base_url @}}Id"
          },
          "original_property": "$source",
          "primary_key": "{{@ base_url @}}Id",
          "rest_system": "{{@ system @}}",
          "share_dataset": "{{@ system @}}-{{@ datatype @}}-share"
        },
        "template": "  {% if operation_lookup is defined %}\n  [\n  {\n    \"type\": \"rest\",\n    \"system\": \"{{ rest_system }}\",\n    \"allowed_status_codes\": \"200,404\",\n    \"operation\": \"{{ operation_lookup }}\",\n    {% if operation_lookup_properties is defined %}\n    \"properties\": {{ operation_lookup_properties | tojson }},\n    {% endif %}\n    \"replace_entity\": false,\n    \"response_property\": \"response_body\",\n    \"response_status_property\": \"response_status\",\n    \"side_effects\": false\n  },\n  {\n      \"type\": \"dtl\",\n      \"rules\": {\n          \"default\": [\n              [\"case-eq\", \"_S.response_status\",\n               200, [\n                   [\"merge\",\n                    [\"first\", \"_S.response_body\"]]\n                   {% if original_property is defined and original_property is string %}\n                   ,\n                   [\"add\", \"{{ original_property }}\", [\"apply\", \"original\", \"_S.\"]]\n                   {% endif %}\n               ],\n               404, [\n                   [\"if\", [\"eq\", \"_S._deleted\", true],\n                    [\n                       \"copy\",\n                       \"*\",\n                       [\"list\", \"response_body\", \"response_status\"]\n                   ],\n                    [\"discard\"]\n                   ]\n               ]\n              ]\n          ]\n          {% if original_property is defined and original_property is string %}\n          ,\n          \"original\": [\n              [\n              \"copy\",\n              \"*\",\n              [\"list\", \"response_body\", \"response_status\"]\n          ]\n          ]\n          {% endif %}\n      }\n  },\n  {% endif %}\n  {\n            \"type\": \"dtl\",\n            \"rules\": {\n                \"default\": [\n                  [\n                    \"copy\",\n                    \"*\"\n                  ],\n                  [\n                    \"add-if\",\n                    \"$origin\",\n                    [\n                      \"first\",\n                      [\n                        \"hops\",\n                        {\n                          \"datasets\": [\n                            \"{{ share_dataset}} st\"\n                          ],\n                          \"return\": \"st.$origin\",\n                          \"track-dependencies\": false,\n                          \"where\": [\n                            {% if primary_key is not string and primary_key is iterable %}\n                            [\n                              \"eq\",\n                              [\"list\", [\"map\", [\"path\", \"_.\", \"_S.\"], [\"literal\", {{ primary_key | tojson }} ]]],\n                              [\"list\", st.$generated_id\"]\n                            ]\n                            {% else %}\n                            [\n                              \"eq\",\n                              \"_S.{{ primary_key }}\",\n                              \"st.$generated_id\"\n                            ]\n                            {% endif %}\n                          ]\n                        }\n                      ]\n                    ]\n                  ]\n                ]\n              }\n            }\n        {% if operation_lookup is defined %}\n        ]\n        {% endif %}\nsesam:markjson",
        "type": "template"
      },
      {
        "rules": {
          "default": [
            [
              "copy",
              "*",
              "$source"
            ],
            [
              "add",
              "$last-modified",
              "_S.$source.{{@ updated_param @}}"
            ]
          ]
        },
        "type": "dtl"
      }
    ],
    "type": "pipe"
  },
  {
    "_id": "{{@ system @}}-{{@ datatype @}}-share",
    "add_namespaces": false,
    "batch_size": 1,
    "compaction": {
      "keep_versions": 100
    },
    "exclude_completeness": [
      "{{@ system @}}-{{@ datatype @}}-share"
    ],
    "namespaced_identifiers": false,
    "sink": {
      "deletion_tracking": false,
      "set_initial_offset": "onload"
    },
    "source": {
      "dataset": "{{@ system @}}-{{@ datatype @}}-transform",
      "type": "dataset"
    },
    "transform": [
      {
        "rules": {
          "default": [
            [
              "copy",
              "*"
            ],
            [
              "comment",
              "Workaround for IS-14640"
            ],
            [
              "if",
              [
                "is-null",
                "_S.{{@ base_url @}}Id"
              ],
              [
                "remove",
                "{{@ base_url @}}Id"
              ]
            ]
          ]
        },
        "type": "dtl"
      },
      {
        "properties": {
          "operation": "defaults",
          "operation_properties": {
            "base_url": "{{@ base_url @}}/default"
          },
          "primary_key": "{{@ base_url @}}Id",
          "rest_system": "{{@ system @}}"
        },
        "template": "transform-defaults-rest",
        "type": "template"
      },
      {
        "properties": {
          "client_side_patching": true,
          "operation_delete_properties": {
            "base_url": "{{@ base_url @}}",
            "lookup_id": "{{@ base_url @}}Id"
          },
          "operation_insert_properties": {
            "base_url": "{{@ base_url @}}"
          },
          "operation_lookup_properties": {
            "base_url": "{{@ base_url @}}",
            "lookup_id": "{{@ base_url @}}Id"
          },
          "operation_update": "put-update",
          "operation_update_properties": {
            "base_url": "{{@ base_url @}}",
            "lookup_id": "{{@ base_url @}}Id"
          },
          "primary_key": "{{@ base_url @}}Id",
          "rest_system": "{{@ system @}}",
          "share_dataset": "{{@ system @}}-{{@ datatype @}}-share"
        },
        "template": "transform-share-rest",
        "type": "template"
      }
    ],
    "type": "pipe"
  }
]