[
  {
    "_id": "{{@ system @}}-{{@ datatype @}}-preshare",
    "namespaced_identifiers": false,
    "source": {
      "dataset": "{{@ system @}}-quotealternative-transform",
      "type": "dataset"
    },
    "transform": [
      {
        "rules": {
          "default": [
            [
              "copy",
              "*"
            ],
            [
              "add-if",
              "SaleId",
              [
                "coalesce",
                [
                  "list",
                  "_S.sesam_SaleId",
                  [
                    "first",
                    [
                      "hops",
                      {
                        "datasets": [
                          "{{@ system @}}-{{@ datatype @}}-share ss"
                        ],
                        "return": "ss.$generated_id",
                        "where": [
                          [
                            "eq",
                            "_S.$ids",
                            "ss.$ids"
                          ]
                        ]
                      }
                    ]
                  ]
                ]
              ]
            ],
            [
              "if",
              [
                "not",
                "_S.sesam_Accepted"
              ],
              [
                "if",
                [
                  "is-not-empty",
                  "_T.SaleId"
                ],
                [
                  "add",
                  "$discard",
                  "already inserted"
                ]
              ],
              [
                "if",
                [
                  "is-not-empty",
                  "_T.SaleId"
                ],
                [
                  [
                    "add-if",
                    "_QuoteId",
                    [
                      "first",
                      [
                        "hops",
                        {
                          "datasets": [
                            "{{@ system @}}-quote-collect qc"
                          ],
                          "return": "qc.QuoteId",
                          "where": [
                            [
                              "eq",
                              "_S.sesam_SaleId",
                              "qc.sesam_SaleId"
                            ]
                          ]
                        }
                      ]
                    ]
                  ],
                  [
                    "if",
                    [
                      "is-not-empty",
                      "_T._QuoteId"
                    ],
                    [
                      [
                        "add",
                        "$operation",
                        "lookup-quote"
                      ],
                      [
                        "add",
                        "payload",
                        [
                          "dict",
                          "QuoteId",
                          "_T._QuoteId"
                        ]
                      ]
                    ],
                    [
                      "add",
                      "$discard",
                      "missing QuoteId"
                    ]
                  ]
                ],
                [
                  "add",
                  "payload",
                  "_S."
                ]
              ]
            ]
          ]
        },
        "type": "dtl"
      },
      {
        "operation": "quote-lookup",
        "response_property": "$trace-pre-lookup-quote",
        "side_effects": false,
        "system": "{{@ system @}}",
        "trigger_on": {
          "key": "$operation",
          "value": "lookup-quote"
        },
        "type": "rest"
      },
      {
        "rules": {
          "default": [
            [
              "if",
              [
                "is-empty",
                "_S.$discard"
              ],
              [
                [
                  "if",
                  [
                    "eq",
                    "_S.$operation",
                    "lookup-quote"
                  ],
                  [
                    "if",
                    [
                      "eq",
                      [
                        "map",
                        "_.State",
                        [
                          "filter",
                          [
                            "eq",
                            [
                              "first",
                              "_.ActiveQuoteVersionId"
                            ],
                            [
                              "first",
                              "_S.$trace-pre-lookup-quote.QuoteVersionId"
                            ]
                          ],
                          "_S.$trace-pre-lookup-quote.QuoteVersions"
                        ]
                      ],
                      "Sold"
                    ],
                    [
                      [
                        "copy",
                        "$ids"
                      ],
                      [
                        "add",
                        "$based_on",
                        [
                          "dict",
                          "Status",
                          "Unknown"
                        ]
                      ],
                      [
                        "add",
                        "$based_on_properties",
                        [
                          "list",
                          "Status"
                        ]
                      ],
                      [
                        "add",
                        "SaleId",
                        "_S.SaleId"
                      ],
                      [
                        "add",
                        "Status",
                        "Sold"
                      ]
                    ],
                    [
                      "add",
                      "$discard",
                      "QuoteVersion not closed"
                    ]
                  ],
                  [
                    [
                      "copy",
                      [
                        "list",
                        "$origin",
                        "$ids"
                      ]
                    ],
                    [
                      "add",
                      "merge",
                      "_S.payload"
                    ]
                  ]
                ]
              ],
              [
                "copy",
                "*"
              ]
            ]
          ]
        },
        "type": "dtl"
      }
    ],
    "type": "pipe"
  },
  {
    "_id": "{{@ system @}}-{{@ datatype @}}-share",
    "add_namespaces": false,
    "batch_size": 1,
    "compaction": {
      "keep_versions": 100
    },
    "exclude_completeness": [
      "{{@ system @}}-{{@ datatype @}}-share"
    ],
    "namespaced_identifiers": false,
    "sink": {
      "deletion_tracking": false,
      "set_initial_offset": "onload"
    },
    "source": {
      "dataset": "{{@ system @}}-{{@ datatype @}}-preshare",
      "type": "dataset"
    },
    "transform": [
      {
        "properties": {
          "operation": "defaults",
          "operation_properties": {
            "base_url": "Sale/default"
          },
          "primary_key": "SaleId",
          "rest_system": "{{@ system @}}"
        },
        "template": "transform-defaults-rest",
        "type": "template"
      },
      {
        "properties": {
          "client_side_patching": true,
          "operation_delete_properties": {
            "base_url": "Sale",
            "lookup_id": "SaleId"
          },
          "operation_insert_properties": {
            "base_url": "Sale"
          },
          "operation_lookup_properties": {
            "base_url": "Sale",
            "lookup_id": "SaleId"
          },
          "operation_update_properties": {
            "base_url": "Sale",
            "lookup_id": "SaleId"
          },
          "primary_key": "SaleId",
          "rest_system": "{{@ system @}}",
          "share_dataset": "{{@ system @}}-{{@ datatype @}}-share"
        },
        "template": "transform-share-rest",
        "type": "template"
      }
    ],
    "type": "pipe"
  }
]