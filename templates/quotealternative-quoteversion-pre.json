{
  "_id": "{{@ system @}}-{{@ datatype @}}-share",
  "namespaced_identifiers": false,
  "rescan_when_config_changes": false,
  "sink": {
    "set-initial-offset": "onload"
  },
  "source": {
    "dataset": "{{@ system @}}-quotealternative-transform",
    "type": "dataset"
  },
  "transform": [
    {
      "rules": {
        "default": [
          [
            "copy",
            "*"
          ],
          [
            "comment",
            "instead of making 2 hops, maybe fix connector to accomodate 2 sources?"
          ],
          [
            "if",
            [
              "is-empty",
              "_S.QuoteVersionId"
            ],
            [
              "add",
              "$discard",
              "Missing QuoteVersionId"
            ],
            [
              [
                "add",
                "$operation",
                "lookup-quoteversion"
              ],
              [
                "add",
                "payload",
                [
                  "dict",
                  "QuoteVersionId",
                  "_T.QuoteVersionId"
                ]
              ]
            ]
          ]
        ]
      },
      "type": "dtl"
    },
    {
      "operation": "quoteversion-lookup",
      "response_property": "$trace-pre-lookup-quoteversion",
      "side_effects": false,
      "system": "{{@ system @}}",
      "trace": true,
      "trigger_on": {
        "key": "$operation",
        "value": "lookup-quoteversion"
      },
      "type": "rest"
    },
    {
      "rules": {
        "default": [
          [
            "copy",
            "*",
            "payload"
          ],
          [
            "add",
            "State",
            [
              "first",
              "_S.$trace-pre-lookup-quoteversion.State"
            ]
          ],
          [
            "if",
            "_S.sesam_Accepted",
            [
              "if",
              [
                "eq",
                "_S.$trace-pre-lookup-quoteversion.State",
                "Draft"
              ],
              [
                "add",
                "$operation",
                "lookup-quotelines"
              ],
              [
                "add",
                "$discard",
                "QuoteVersion is open/Draft"
              ]
            ],
            [
              "add",
              "$discard",
              "No sesam_Accepted"
            ]
          ]
        ]
      },
      "type": "dtl"
    },
    {
      "operation": "quoteline-list",
      "response_property": "$trace-pre-lookup-quotelines",
      "side_effects": false,
      "system": "{{@ system @}}",
      "trigger_on": {
        "key": "$operation",
        "value": "lookup-quotelines"
      },
      "type": "rest"
    },
    {
      "rules": {
        "default": [
          [
            "copy",
            "*"
          ],
          [
            "if",
            [
              "and",
              [
                "eq",
                "_S.$operation",
                "lookup-quotelines"
              ],
              [
                "is-not-empty",
                "_S.$trace-pre-lookup-quotelines"
              ]
            ],
            [
              "add",
              "payload",
              [
                "dict",
                "QuoteVersion",
                [
                  "apply",
                  "recursive-merge",
                  [
                    "dict",
                    "a",
                    [
                      "first",
                      "_S.$trace-pre-lookup-quoteversion"
                    ],
                    "b",
                    [
                      "dict",
                      "State",
                      "Sold"
                    ]
                  ]
                ]
              ]
            ]
          ]
        ],
        "recursive-merge": [
          [
            "merge",
            [
              "dict",
              [
                "map",
                [
                  "list",
                  "_.",
                  [
                    "sorted",
                    [
                      "if",
                      [
                        "and",
                        [
                          "is-dict",
                          [
                            "path",
                            "_.",
                            "_S.a"
                          ]
                        ],
                        [
                          "is-dict",
                          [
                            "path",
                            "_.",
                            "_S.b"
                          ]
                        ]
                      ],
                      [
                        "apply",
                        "recursive-merge",
                        [
                          "dict",
                          "a",
                          [
                            "path",
                            "_.",
                            "_S.a"
                          ],
                          "b",
                          [
                            "path",
                            "_.",
                            "_S.b"
                          ]
                        ]
                      ],
                      [
                        "if",
                        [
                          "has-key",
                          "_.",
                          "_S.b"
                        ],
                        [
                          "path",
                          "_.",
                          "_S.b"
                        ],
                        [
                          "path",
                          "_.",
                          "_S.a"
                        ]
                      ]
                    ]
                  ]
                ],
                [
                  "distinct",
                  [
                    "combine",
                    [
                      "keys",
                      "_S.a"
                    ],
                    [
                      "keys",
                      "_S.b"
                    ]
                  ]
                ]
              ]
            ]
          ]
        ]
      },
      "type": "dtl"
    }
  ],
  "type": "pipe"
}