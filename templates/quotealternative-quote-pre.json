{
  "_id": "{{@ system @}}-{{@ datatype @}}-share",
  "namespaced_identifiers": false,
  "rescan_when_config_changes": false,
  "sink": {
    "set-initial-offset": "onload"
  },
  "source": {
    "dataset": "{{@ system @}}-quotealternative-transform",
    "type": "dataset"
  },
  "transform": {
    "transforms": [
      {
        "rules": {
          "default": [
            [
              "copy",
              "*"
            ],
            [
              "comment",
              "instead of making 2 hops, maybe fix connector to accomodate 2 sources?"
            ],
            [
              "add",
              "SaleId",
              [
                "coalesce",
                [
                  "list",
                  "_S.sesam_SaleId",
                  [
                    "first",
                    [
                      "hops",
                      {
                        "datasets": [
                          "{{@ system @}}-sale-share sh"
                        ],
                        "return": "sh.$generated_id",
                        "where": [
                          [
                            "eq",
                            "_S.$ids",
                            "sh.$ids"
                          ]
                        ]
                      }
                    ]
                  ],
                  [
                    "first",
                    [
                      "hops",
                      {
                        "datasets": [
                          "{{@ system @}}-quotealternative-sale-share sh"
                        ],
                        "return": "sh.$generated_id",
                        "where": [
                          [
                            "eq",
                            "_S.$ids",
                            "sh.$ids"
                          ]
                        ]
                      }
                    ]
                  ]
                ]
              ]
            ],
            [
              "if",
              [
                "is-null",
                "_T.SaleId"
              ],
              [
                "add",
                "$discard",
                "missing SaleId"
              ],
              [
                [
                  "add",
                  "$operation",
                  "lookup-sale"
                ],
                [
                  "add",
                  "payload",
                  [
                    "dict",
                    "SaleId",
                    "_T.SaleId"
                  ]
                ]
              ]
            ]
          ]
        },
        "type": "dtl"
      },
      {
        "operation": "quotealternative-sale-lookup",
        "response_property": "$trace-pre-lookup-sale",
        "side_effects": false,
        "system": "{{@ system @}}",
        "trigger_on": {
          "key": "$operation",
          "value": "lookup-sale"
        },
        "type": "rest"
      },
      {
        "rules": {
          "default": [
            [
              "copy",
              "*"
            ],
            [
              "add",
              "QuoteId",
              [
                "first",
                "_S.$trace-pre-lookup-sale.QuoteId"
              ]
            ],
            [
              "comment",
              "TODO"
            ],
            [
              "comment",
              "support update for AcceptedQuoteAlternative"
            ],
            [
              "if",
              [
                "is-null",
                "_T.QuoteId"
              ],
              [
                "add",
                "payload",
                [
                  "dict",
                  "ConnectionId",
                  1,
                  "SaleId",
                  "_S.SaleId"
                ]
              ],
              [
                [
                  "add",
                  "payload",
                  [
                    "dict",
                    "QuoteId",
                    "_T.QuoteId"
                  ]
                ],
                [
                  "add",
                  "$operation",
                  "lookup-quote"
                ]
              ]
            ]
          ]
        },
        "type": "dtl"
      },
      {
        "operation": "quote-lookup",
        "response_property": "$trace-pre-lookup-quote",
        "side_effects": false,
        "system": "{{@ system @}}",
        "trigger_on": {
          "key": "$operation",
          "value": "lookup-quote"
        },
        "type": "rest"
      },
      {
        "rules": {
          "default": [
            [
              "copy",
              "*"
            ],
            [
              "if",
              [
                "eq",
                "_S.$operation",
                "lookup-quote"
              ],
              [
                "if",
                [
                  "and",
                  [
                    "in",
                    "~:wd:Q566889",
                    [
                      "flatten",
                      [
                        "hops",
                        {
                          "datasets": [
                            "86842f770c62-global-agreement ga"
                          ],
                          "return": "ga.ps:P31",
                          "where": [
                            [
                              "eq",
                              "_S.$ids",
                              "ga.$ids"
                            ]
                          ]
                        }
                      ]
                    ]
                  ],
                  [
                    "eq",
                    [
                      "first",
                      "_S.$trace-pre-lookup-quote.AcceptedQuoteAlternativeId"
                    ],
                    0
                  ]
                ],
                [
                  "add",
                  "payload",
                  [
                    "dict",
                    "Quote",
                    [
                      "apply",
                      "recursive-merge",
                      [
                        "dict",
                        "a",
                        [
                          "first",
                          "_S.$trace-pre-lookup-quote"
                        ],
                        "b",
                        [
                          "dict",
                          "AcceptedQuoteAlternativeId",
                          [
                            "first",
                            "_S.$trace-pre-lookup-sale.FavoriteQuoteAlternative.QuoteAlternativeId"
                          ]
                        ]
                      ]
                    ]
                  ]
                ],
                [
                  "add",
                  "$discard",
                  "AcceptedQuoteAlternative probably already updated"
                ]
              ]
            ]
          ],
          "recursive-merge": [
            [
              "merge",
              [
                "dict",
                [
                  "map",
                  [
                    "list",
                    "_.",
                    [
                      "sorted",
                      [
                        "if",
                        [
                          "and",
                          [
                            "is-dict",
                            [
                              "path",
                              "_.",
                              "_S.a"
                            ]
                          ],
                          [
                            "is-dict",
                            [
                              "path",
                              "_.",
                              "_S.b"
                            ]
                          ]
                        ],
                        [
                          "apply",
                          "recursive-merge",
                          [
                            "dict",
                            "a",
                            [
                              "path",
                              "_.",
                              "_S.a"
                            ],
                            "b",
                            [
                              "path",
                              "_.",
                              "_S.b"
                            ]
                          ]
                        ],
                        [
                          "if",
                          [
                            "has-key",
                            "_.",
                            "_S.b"
                          ],
                          [
                            "path",
                            "_.",
                            "_S.b"
                          ],
                          [
                            "path",
                            "_.",
                            "_S.a"
                          ]
                        ]
                      ]
                    ]
                  ],
                  [
                    "distinct",
                    [
                      "combine",
                      [
                        "keys",
                        "_S.a"
                      ],
                      [
                        "keys",
                        "_S.b"
                      ]
                    ]
                  ]
                ]
              ]
            ]
          ]
        },
        "type": "dtl"
      }
    ],
    "type": "chained"
  },
  "type": "pipe"
}