[
  {
    "_id": "{{@ system @}}-{{@ datatype @}}-preshare",
    "namespaced_identifiers": false,
    "sink": {
      "set-initial-offset": "onload"
    },
    "source": {
      "dataset": "{{@ system @}}-quotealternative-transform",
      "type": "dataset"
    },
    "transform": [
      {
        "transforms": [
          {
            "rules": {
              "default": [
                [
                  "filter",
                  "_S.sesam_Accepted"
                ],
                [
                  "copy",
                  "*"
                ],
                [
                  "comment",
                  "instead of making 2 hops, maybe fix connector to accomodate 2 sources?"
                ],
                [
                  "add",
                  "SaleId",
                  [
                    "coalesce",
                    [
                      "list",
                      "_S.sesam_SaleId",
                      [
                        "first",
                        [
                          "hops",
                          {
                            "datasets": [
                              "{{@ system @}}-sale-share sh"
                            ],
                            "return": "sh.$generated_id",
                            "where": [
                              [
                                "eq",
                                "_S.$ids",
                                "sh.$ids"
                              ]
                            ]
                          }
                        ]
                      ],
                      [
                        "first",
                        [
                          "hops",
                          {
                            "datasets": [
                              "{{@ system @}}-quotealternativesale-share sh"
                            ],
                            "return": "sh.$generated_id",
                            "where": [
                              [
                                "eq",
                                "_S.$ids",
                                "sh.$ids"
                              ]
                            ]
                          }
                        ]
                      ]
                    ]
                  ]
                ],
                [
                  "if",
                  [
                    "is-null",
                    "_T.SaleId"
                  ],
                  [
                    "add",
                    "$discard",
                    "missing SaleId"
                  ],
                  [
                    [
                      "add",
                      "$operation",
                      "lookup-sale"
                    ],
                    [
                      "add",
                      "payload",
                      [
                        "dict",
                        "SaleId",
                        "_T.SaleId"
                      ]
                    ]
                  ]
                ]
              ]
            },
            "type": "dtl"
          },
          {
            "operation": "quotealternativesale-lookup",
            "response_property": "$trace-pre-lookup-sale",
            "side_effects": false,
            "system": "{{@ system @}}",
            "trigger_on": {
              "key": "$operation",
              "value": "lookup-sale"
            },
            "type": "rest"
          },
          {
            "rules": {
              "default": [
                [
                  "copy",
                  "*"
                ],
                [
                  "add",
                  "QuoteId",
                  [
                    "first",
                    "_S.$trace-pre-lookup-sale.QuoteId"
                  ]
                ],
                [
                  "comment",
                  "TODO"
                ],
                [
                  "comment",
                  "support update for AcceptedQuoteAlternative"
                ],
                [
                  "if",
                  [
                    "is-null",
                    "_T.QuoteId"
                  ],
                  [
                    "add",
                    "payload",
                    [
                      "dict",
                      "ConnectionId",
                      1,
                      "SaleId",
                      "_S.SaleId"
                    ]
                  ],
                  [
                    [
                      "add",
                      "payload",
                      [
                        "dict",
                        "QuoteId",
                        "_T.QuoteId"
                      ]
                    ],
                    [
                      "add",
                      "$operation",
                      "lookup-quote"
                    ]
                  ]
                ]
              ]
            },
            "type": "dtl"
          },
          {
            "operation": "quote-lookup",
            "response_property": "$trace-pre-lookup-quote",
            "side_effects": false,
            "system": "{{@ system @}}",
            "trigger_on": {
              "key": "$operation",
              "value": "lookup-quote"
            },
            "type": "rest"
          },
          {
            "rules": {
              "default": [
                [
                  "copy",
                  "$ids"
                ],
                [
                  "if",
                  [
                    "eq",
                    "_S.$operation",
                    "lookup-quote"
                  ],
                  [
                    "if",
                    [
                      "eq",
                      [
                        "first",
                        "_S.$trace-pre-lookup-quote.AcceptedQuoteAlternativeId"
                      ],
                      0
                    ],
                    [
                      [
                        "copy",
                        "$ids"
                      ],
                      [
                        "copy",
                        "QuoteId"
                      ],
                      [
                        "add",
                        "$based_on_properties",
                        [
                          "list",
                          "AcceptedQuoteAlternativeId"
                        ]
                      ],
                      [
                        "add",
                        "$based_on",
                        [
                          "dict",
                          "AcceptedQuoteAlternativeId",
                          [
                            "first",
                            "_S.$trace-pre-lookup-quote.AcceptedQuoteAlternativeId"
                          ]
                        ]
                      ],
                      [
                        "add",
                        "AcceptedQuoteAlternativeId",
                        [
                          "first",
                          "_S.$trace-pre-lookup-sale.FavoriteQuoteAlternative.QuoteAlternativeId"
                        ]
                      ],
                      [
                        "add",
                        "$payload",
                        [
                          "dict",
                          "Quote",
                          [
                            "dict",
                            "QuoteConnectionId",
                            1,
                            "QuoteId",
                            "_S.QuoteId",
                            "SaleId",
                            "_S.SaleId",
                            "AcceptedQuoteAlternativeId",
                            [
                              "first",
                              "_S.$trace-pre-lookup-sale.FavoriteQuoteAlternative.QuoteAlternativeId"
                            ]
                          ]
                        ]
                      ]
                    ],
                    [
                      "add",
                      "$discard",
                      "AcceptedQuoteAlternative already set"
                    ]
                  ],
                  [
                    [
                      "add",
                      "$payload",
                      "_S.payload"
                    ],
                    [
                      "copy",
                      [
                        "list",
                        "$origin",
                        "$ids"
                      ]
                    ]
                  ]
                ]
              ],
              "recursive-merge": [
                [
                  "merge",
                  [
                    "dict",
                    [
                      "map",
                      [
                        "list",
                        "_.",
                        [
                          "sorted",
                          [
                            "if",
                            [
                              "and",
                              [
                                "is-dict",
                                [
                                  "path",
                                  "_.",
                                  "_S.a"
                                ]
                              ],
                              [
                                "is-dict",
                                [
                                  "path",
                                  "_.",
                                  "_S.b"
                                ]
                              ]
                            ],
                            [
                              "apply",
                              "recursive-merge",
                              [
                                "dict",
                                "a",
                                [
                                  "path",
                                  "_.",
                                  "_S.a"
                                ],
                                "b",
                                [
                                  "path",
                                  "_.",
                                  "_S.b"
                                ]
                              ]
                            ],
                            [
                              "if",
                              [
                                "has-key",
                                "_.",
                                "_S.b"
                              ],
                              [
                                "path",
                                "_.",
                                "_S.b"
                              ],
                              [
                                "path",
                                "_.",
                                "_S.a"
                              ]
                            ]
                          ]
                        ]
                      ],
                      [
                        "distinct",
                        [
                          "combine",
                          [
                            "keys",
                            "_S.a"
                          ],
                          [
                            "keys",
                            "_S.b"
                          ]
                        ]
                      ]
                    ]
                  ]
                ]
              ]
            },
            "type": "dtl"
          },
          {
            "operation": "quoteline-list",
            "response_property": "$trace-pre-lookup-quotelines",
            "side_effects": false,
            "system": "{{@ system @}}",
            "trigger_on": {
              "key": "$operation",
              "value": "lookup-quotelines"
            },
            "type": "rest"
          }
        ],
        "type": "chained"
      },
      {
        "rules": {
          "default": [
            [
              "copy",
              "$ids"
            ],
            [
              "if",
              [
                "eq",
                "_S.$operation",
                "lookup-quotelines"
              ],
              [
                "if",
                [
                  "is-not-empty",
                  "_S.$trace-pre-lookup-quotelines"
                ],
                [
                  [
                    "copy",
                    "QuoteId"
                  ],
                  [
                    "add",
                    "$based_on_properties",
                    [
                      "list",
                      "AcceptedQuoteAlternativeId"
                    ]
                  ],
                  [
                    "add",
                    "$based_on",
                    [
                      "dict",
                      "AcceptedQuoteAlternativeId",
                      [
                        "first",
                        "_S.$trace-pre-lookup-quote.AcceptedQuoteAlternativeId"
                      ]
                    ]
                  ],
                  [
                    "add",
                    "AcceptedQuoteAlternativeId",
                    [
                      "first",
                      "_S.$trace-pre-lookup-quote.AcceptedQuoteAlternativeId"
                    ]
                  ],
                  [
                    "add",
                    "$payload",
                    [
                      "dict",
                      "QuoteAlternativeId",
                      [
                        "first",
                        "_S.$trace-pre-lookup-quote.AcceptedQuoteAlternativeId"
                      ],
                      "MarkSaleAsSold",
                      true
                    ]
                  ]
                ],
                [
                  "add",
                  "$discard",
                  "no quotelines available yet"
                ]
              ],
              [
                "copy",
                "*"
              ]
            ]
          ]
        },
        "type": "dtl"
      }
    ],
    "type": "pipe"
  },
  {
    "_id": "{{@ system @}}-{{@ datatype @}}-share",
    "add_namespaces": false,
    "batch_size": 1,
    "compaction": {
      "keep_versions": 100
    },
    "exclude_completeness": [
      "{{@ system @}}-{{@ datatype @}}-share"
    ],
    "namespaced_identifiers": false,
    "sink": {
      "deletion_tracking": false,
      "set_initial_offset": "onload"
    },
    "source": {
      "dataset": "{{@ system @}}-{{@ datatype @}}-preshare",
      "type": "dataset"
    },
    "transform": [
      {
        "properties": {
          "operation": "defaults",
          "operation_properties": {
            "base_url": "Sale/default"
          },
          "primary_key": "SaleId",
          "rest_system": "{{@ system @}}"
        },
        "template": "transform-defaults-rest",
        "type": "template"
      },
      {
        "properties": {
          "operation_insert": "create-quote",
          "operation_lookup": "quote-lookup",
          "operation_update": "update-quote",
          "primary_key": "QuoteId",
          "rest_system": "{{@ system @}}",
          "share_dataset": "{{@ system @}}-{{@ datatype @}}-share"
        },
        "template": "transform-share-rest",
        "type": "template"
      }
    ],
    "type": "pipe"
  }
]