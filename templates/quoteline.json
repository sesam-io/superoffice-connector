[
  {
    "_id": "{{@ system @}}-{{@ datatype @}}-all",
    "namespaced_identifiers": false,
    "source": {
      "dataset": "{{@ system @}}-{{@ parent @}}-collect",
      "type": "dataset"
    },
    "transform": [
      {
        "operation": "{{@ datatype @}}-list",
        "system": "{{@ system @}}",
        "type": "rest"
      },
      {
        "rules": {
          "create_versions": [
            [
              "copy",
              "*"
            ],
            [
              "add",
              "_id",
              [
                "string",
                "_S.QuoteLineId"
              ]
            ],
            [
              "add",
              "$original_id",
              "_R._S._id"
            ],
            [
              "add",
              "$last-modified",
              "_R._S.$last-modified"
            ]
          ],
          "default": [
            [
              "create-child",
              [
                "apply",
                "create_versions",
                "_S.response"
              ]
            ]
          ]
        },
        "type": "dtl"
      }
    ],
    "type": "pipe"
  },
  {
    "_id": "{{@ system @}}-{{@ datatype @}}-all2",
    "namespaced_identifiers": false,
    "source": {
      "dataset": "{{@ system @}}-{{@ datatype @}}-all",
      "type": "dataset"
    },
    "transform": {
      "type": "emit_children"
    },
    "type": "pipe"
  },
  {
    "_id": "{{@ system @}}-{{@ datatype @}}-collect",
    "exclude_completeness": [
      "{{@ system @}}-{{@ datatype @}}-share"
    ],
    "namespaced_identifiers": false,
    "source": {
      "dataset": "{{@ system @}}-{{@ datatype @}}-all2",
      "type": "dataset"
    },
    "transform": {
      "properties": {
        "primary_key": "QuoteLineId",
        "share_dataset": "{{@ system @}}-{{@ datatype @}}-share"
      },
      "template": "transform-collect-rest",
      "type": "template"
    },
    "type": "pipe"
  },
  {
    "_id": "{{@ system @}}-{{@ datatype @}}-share",
    "add_namespaces": false,
    "batch_size": 1,
    "compaction": {
      "keep_versions": 100
    },
    "exclude_completeness": [
      "{{@ system @}}-{{@ datatype @}}-share"
    ],
    "namespaced_identifiers": false,
    "sink": {
      "deletion_tracking": false,
      "set_initial_offset": "onload"
    },
    "source": {
      "dataset": "{{@ system @}}-{{@ datatype @}}-transform",
      "type": "dataset"
    },
    "transform": [
      {
        "rules": {
          "default": [
            [
              "comment",
              "IS-16810: Calculating DiscountAmount based on DiscountPercentage since DiscountAmount is required to calculate TotalPrice"
            ],
            [
              "copy",
              "*"
            ],
            [
              "if",
              [
                "is-not-null",
                "_S.ERPDiscountPercent"
              ],
              [
                "add",
                "ERPDiscountAmount",
                [
                  "round",
                  2,
                  [
                    "multiply",
                    "_S.UnitListPrice",
                    [
                      "divide",
                      100,
                      "_S.ERPDiscountPercent"
                    ]
                  ]
                ]
              ]
            ]
          ]
        },
        "type": "dtl"
      },
      {
        "rules": {
          "default": [
            [
              "comment",
              "first if clause here where the $operation discard-QuoteAlternativeId-missing is set, is a workaround for now. (IS-14730) will implement robust fix"
            ],
            [
              "if",
              [
                "and",
                [
                  "neq",
                  "_S._deleted",
                  true
                ],
                [
                  "is-null",
                  "_S.QuoteAlternativeId"
                ]
              ],
              [
                [
                  "add",
                  "$source",
                  "_S."
                ],
                [
                  "add",
                  "$operation",
                  "discard-QuoteAlternativeId-missing"
                ]
              ],
              [
                "if",
                [
                  "and",
                  [
                    "neq",
                    "_S._deleted",
                    true
                  ],
                  [
                    "all",
                    [
                      "is-null",
                      "_."
                    ],
                    [
                      "map",
                      [
                        "path",
                        "_.",
                        "_S."
                      ],
                      [
                        "literal",
                        "QuoteLineId"
                      ]
                    ]
                  ]
                ],
                [
                  [
                    "add",
                    "$source",
                    "_S."
                  ],
                  [
                    "add",
                    "$operation",
                    "lookup-defaults"
                  ]
                ],
                [
                  "copy",
                  "*"
                ]
              ]
            ]
          ]
        },
        "type": "dtl"
      },
      {
        "allowed_status_codes": "200",
        "operation": "{{@ datatype @}}-default",
        "side_effects": false,
        "system": "{{@ system @}}",
        "trigger_on": {
          "key": "$operation",
          "value": "lookup-defaults"
        },
        "type": "rest"
      },
      {
        "rules": {
          "default": [
            [
              "if",
              [
                "eq",
                "_S.$operation",
                "lookup-defaults"
              ],
              [
                "merge",
                [
                  "apply",
                  "recursive-merge",
                  [
                    "dict",
                    "a",
                    [
                      "apply",
                      "remove-primary-key",
                      [
                        "first",
                        "_S.response"
                      ]
                    ],
                    "b",
                    "_S.$source"
                  ]
                ]
              ],
              [
                "copy",
                "*"
              ]
            ]
          ],
          "recursive-merge": [
            [
              "merge",
              [
                "dict",
                [
                  "map",
                  [
                    "list",
                    "_.",
                    [
                      "sorted",
                      [
                        "if",
                        [
                          "and",
                          [
                            "is-dict",
                            [
                              "path",
                              "_.",
                              "_S.a"
                            ]
                          ],
                          [
                            "is-dict",
                            [
                              "path",
                              "_.",
                              "_S.b"
                            ]
                          ]
                        ],
                        [
                          "apply",
                          "recursive-merge",
                          [
                            "dict",
                            "a",
                            [
                              "path",
                              "_.",
                              "_S.a"
                            ],
                            "b",
                            [
                              "path",
                              "_.",
                              "_S.b"
                            ]
                          ]
                        ],
                        [
                          "if",
                          [
                            "has-key",
                            "_.",
                            "_S.b"
                          ],
                          [
                            "path",
                            "_.",
                            "_S.b"
                          ],
                          [
                            "path",
                            "_.",
                            "_S.a"
                          ]
                        ]
                      ]
                    ]
                  ],
                  [
                    "distinct",
                    [
                      "combine",
                      [
                        "keys",
                        "_S.a"
                      ],
                      [
                        "keys",
                        "_S.b"
                      ]
                    ]
                  ]
                ]
              ]
            ]
          ],
          "remove-primary-key": [
            [
              "copy",
              "*",
              [
                "literal",
                "QuoteLineId"
              ]
            ]
          ]
        },
        "type": "dtl"
      },
      {
        "rules": {
          "default": [
            [
              "copy",
              "*"
            ],
            [
              "comment",
              "below logic has been added to support inserts and updates for this datatype"
            ],
            [
              "if",
              [
                "is-empty",
                "_R._S.QuoteLineId"
              ],
              [
                [
                  "comment",
                  "on inserts QuoteAlternativeId must be set and ERPProductKey must also be set to at least an empty string. It does not however require a foreign key relation of type product+pricelist"
                ],
                [
                  "comment",
                  "on inserts Rank must be set to 1."
                ],
                [
                  "add",
                  "QuoteLineId",
                  0
                ],
                [
                  "add",
                  "$payload",
                  [
                    "dict",
                    "Quoteline",
                    [
                      "map-dict",
                      [
                        "filter",
                        [
                          "and",
                          [
                            "neq",
                            "$",
                            [
                              "substring",
                              0,
                              1,
                              "_."
                            ]
                          ],
                          [
                            "neq",
                            "_",
                            [
                              "substring",
                              0,
                              1,
                              "_."
                            ]
                          ]
                        ],
                        "_."
                      ],
                      "_.",
                      "_T."
                    ]
                  ]
                ],
                [
                  "remove",
                  "QuoteLineId"
                ]
              ],
              [
                "add",
                "$payload",
                [
                  "dict",
                  "Quoteline",
                  [
                    "map-dict",
                    [
                      "filter",
                      [
                        "and",
                        [
                          "neq",
                          "$",
                          [
                            "substring",
                            0,
                            1,
                            "_."
                          ]
                        ],
                        [
                          "neq",
                          "_",
                          [
                            "substring",
                            0,
                            1,
                            "_."
                          ]
                        ]
                      ],
                      "_."
                    ],
                    "_.",
                    "_S."
                  ]
                ]
              ]
            ]
          ]
        },
        "type": "dtl"
      },
      {
        "rules": {
          "default": [
            [
              "copy",
              [
                "literal",
                "QuoteLineId"
              ]
            ],
            [
              "add",
              "$source",
              "_S."
            ],
            [
              "copy",
              "$origin"
            ],
            [
              "copy",
              "$replaced"
            ],
            [
              "comment",
              "if clause here where the $operation discard-QuoteAlternativeId-missing is set, is a workaround for now. (IS-14730) will implement robust fix"
            ],
            [
              "if",
              [
                "eq",
                "_S.$operation",
                "discard-QuoteAlternativeId-missing"
              ],
              [
                "copy",
                [
                  "list",
                  "$operation",
                  "$source"
                ]
              ],
              [
                "if",
                [
                  "and",
                  [
                    "eq",
                    "_S.$replaced",
                    true
                  ],
                  [
                    "eq",
                    "_S._deleted",
                    true
                  ]
                ],
                [
                  "merge",
                  [
                    "apply",
                    "discard-replaced",
                    "_S."
                  ]
                ],
                [
                  "if",
                  [
                    "all",
                    [
                      "is-not-null",
                      "_."
                    ],
                    [
                      "map",
                      [
                        "path",
                        "_.",
                        "_S."
                      ],
                      [
                        "literal",
                        "QuoteLineId"
                      ]
                    ]
                  ],
                  [
                    "if",
                    [
                      "eq",
                      "_S._deleted",
                      true
                    ],
                    [
                      [
                        "comment",
                        "Entity is deleted and it does have a system specific id."
                      ],
                      [
                        "merge",
                        [
                          "apply",
                          "delete",
                          "_S."
                        ]
                      ]
                    ],
                    [
                      [
                        "comment",
                        "Entity is not deleted and it does have a system specific id."
                      ],
                      [
                        "merge",
                        [
                          "apply",
                          "lookup",
                          "_S."
                        ]
                      ]
                    ]
                  ],
                  [
                    "if",
                    [
                      "eq",
                      "_S._deleted",
                      true
                    ],
                    [
                      "merge",
                      [
                        "apply",
                        "discard-delete-non-existent",
                        "_S."
                      ]
                    ],
                    [
                      [
                        "comment",
                        "At this point there is no primary key, so we should do an insert unless there are sink entity ids in $ids with $generated_id in them."
                      ],
                      [
                        "if",
                        [
                          "is-not-empty",
                          [
                            "filter",
                            [
                              "is-not-null",
                              "_."
                            ],
                            [
                              "hops",
                              {
                                "datasets": [
                                  "{{@ system @}}-{{@ datatype @}}-share st"
                                ],
                                "return": "st.$generated_id",
                                "track-dependencies": false,
                                "where": [
                                  [
                                    "eq",
                                    "_S.$ids",
                                    [
                                      "ni",
                                      "st._id"
                                    ]
                                  ]
                                ]
                              }
                            ]
                          ]
                        ],
                        [
                          "merge",
                          [
                            "apply",
                            "discard-already-inserted",
                            "_S."
                          ]
                        ],
                        [
                          [
                            "comment",
                            "Entity is not deleted, it does not have a system specific id and it does not exist in sink dataset."
                          ],
                          [
                            "merge",
                            [
                              "apply",
                              "insert",
                              "_S."
                            ]
                          ]
                        ]
                      ]
                    ]
                  ]
                ]
              ]
            ]
          ],
          "delete": [
            [
              "add",
              "$operation",
              "discard-deletes-not-enabled"
            ]
          ],
          "discard-already-inserted": [
            [
              "add",
              "$operation",
              "discard-already-inserted"
            ]
          ],
          "discard-delete-non-existent": [
            [
              "add",
              "$operation",
              "discard-delete-non-existent"
            ]
          ],
          "discard-replaced": [
            [
              "add",
              "$operation",
              "discard-replaced"
            ]
          ],
          "insert": [
            [
              "add",
              "$operation",
              "insert"
            ],
            [
              "add",
              "_payload",
              [
                "if",
                [
                  "is-not-null",
                  "_R._T.$source.$payload"
                ],
                "_R._T.$source.$payload",
                [
                  "apply",
                  "payload",
                  "_R._T.$source"
                ]
              ]
            ],
            [
              "add",
              "payload",
              "_T._payload"
            ]
          ],
          "lookup": [
            [
              "add",
              "$operation",
              "lookup"
            ]
          ],
          "payload": [
            [
              "merge",
              [
                "dict",
                [
                  "filter",
                  [
                    "not",
                    [
                      "or",
                      [
                        "matches",
                        "_*",
                        [
                          "first",
                          "_."
                        ]
                      ],
                      [
                        "matches",
                        "$*",
                        [
                          "first",
                          "_."
                        ]
                      ]
                    ]
                  ],
                  [
                    "items",
                    "_S."
                  ]
                ]
              ]
            ]
          ]
        },
        "type": "dtl"
      },
      {
        "allowed_status_codes": "100-599",
        "operation": "{{@ datatype @}}-lookup",
        "replace_entity": false,
        "response_property": "response_body",
        "response_status_property": "response_status",
        "side_effects": false,
        "system": "{{@ system @}}",
        "trigger_on": {
          "key": "$operation",
          "value": "lookup"
        },
        "type": "rest"
      },
      {
        "rules": {
          "based-on-comparison": [
            [
              "comment",
              "If looked up entity is different from $based_on then noop. If looked up entity is same as _S then noop - otherwise perform update"
            ],
            [
              "merge",
              [
                "apply",
                "based-on-source",
                "_S."
              ]
            ],
            [
              "merge",
              [
                "apply",
                "based-on-lookup",
                "_S."
              ]
            ],
            [
              "merge",
              [
                "apply",
                "based-on-update",
                "_S."
              ]
            ],
            [
              "if",
              [
                "neq",
                "_T.$based_on_lookup",
                "_T.$based_on_source"
              ],
              [
                "add",
                "$result",
                "modified-in-system"
              ],
              [
                "if",
                [
                  "neq",
                  "_T.$based_on_update",
                  "_T.$based_on_source"
                ],
                [
                  "add",
                  "$result",
                  "needs-update"
                ],
                [
                  "add",
                  "$result",
                  "entity-not-changed"
                ]
              ]
            ]
          ],
          "based-on-lookup": [
            [
              "add",
              "$based_on_lookup",
              [
                "apply",
                "remove-unmapped-properties",
                [
                  "dict",
                  "prefix",
                  "",
                  "data",
                  [
                    "first",
                    "_S.response_body"
                  ]
                ]
              ]
            ]
          ],
          "based-on-source": [
            [
              "add",
              "$based_on_source",
              "_S.$source.$based_on"
            ]
          ],
          "based-on-update": [
            [
              "add",
              "$based_on_update",
              [
                "apply",
                "remove-unmapped-properties",
                [
                  "dict",
                  "prefix",
                  "",
                  "data",
                  "_S.$source"
                ]
              ]
            ]
          ],
          "default": [
            [
              "if",
              [
                "neq",
                "_S.$operation",
                "lookup"
              ],
              [
                [
                  "if",
                  [
                    "eq",
                    "_S.$operation",
                    "insert"
                  ],
                  [
                    "if",
                    [
                      "is-null",
                      "_S.$origin"
                    ],
                    [
                      "fail!",
                      "Entity to be inserted does not have $origin property"
                    ]
                  ]
                ],
                [
                  "copy",
                  "*"
                ]
              ],
              [
                [
                  "if",
                  [
                    "neq",
                    "_S.response_status",
                    200
                  ],
                  [
                    "copy",
                    "*"
                  ],
                  [
                    [
                      "add",
                      "$comparison",
                      [
                        "apply",
                        "based-on-comparison",
                        "_S."
                      ]
                    ],
                    [
                      "case-eq",
                      [
                        "path",
                        "$result",
                        "_T.$comparison"
                      ],
                      "modified-in-system",
                      [
                        "merge",
                        [
                          "apply",
                          "discard-modified-in-system",
                          "_S."
                        ]
                      ],
                      "entity-not-changed",
                      [
                        "merge",
                        [
                          "apply",
                          "discard-entity-not-changed",
                          "_S."
                        ]
                      ],
                      [
                        "merge",
                        [
                          "apply",
                          "update",
                          "_S."
                        ]
                      ]
                    ],
                    [
                      "copy",
                      "$source"
                    ],
                    [
                      "copy",
                      [
                        "literal",
                        "QuoteLineId"
                      ]
                    ],
                    [
                      "copy",
                      "$origin"
                    ],
                    [
                      "copy",
                      "$replaced"
                    ],
                    [
                      "add",
                      "$trace_lookup",
                      [
                        "apply",
                        "trace",
                        "_S."
                      ]
                    ]
                  ]
                ]
              ]
            ]
          ],
          "discard-entity-not-changed": [
            [
              "add",
              "$operation",
              "discard-entity-not-changed"
            ]
          ],
          "discard-modified-in-system": [
            [
              "add",
              "$operation",
              "discard-modified-in-system"
            ]
          ],
          "is-match": [
            [
              "comment",
              "workaround for shadowing the outer _. variable"
            ],
            [
              "discard",
              [
                "is-not-empty",
                [
                  "filter",
                  [
                    "matches",
                    "_S.pattern",
                    "_."
                  ],
                  "_R._S.$source.$based_on_properties"
                ]
              ]
            ]
          ],
          "payload": [
            [
              "merge",
              [
                "dict",
                [
                  "filter",
                  [
                    "not",
                    [
                      "or",
                      [
                        "matches",
                        "_*",
                        [
                          "first",
                          "_."
                        ]
                      ],
                      [
                        "matches",
                        "$*",
                        [
                          "first",
                          "_."
                        ]
                      ]
                    ]
                  ],
                  [
                    "items",
                    "_S."
                  ]
                ]
              ]
            ]
          ],
          "recursive-merge": [
            [
              "merge",
              [
                "dict",
                [
                  "map",
                  [
                    "list",
                    "_.",
                    [
                      "sorted",
                      [
                        "if",
                        [
                          "and",
                          [
                            "is-dict",
                            [
                              "path",
                              "_.",
                              "_S.a"
                            ]
                          ],
                          [
                            "is-dict",
                            [
                              "path",
                              "_.",
                              "_S.b"
                            ]
                          ]
                        ],
                        [
                          "apply",
                          "recursive-merge",
                          [
                            "dict",
                            "a",
                            [
                              "path",
                              "_.",
                              "_S.a"
                            ],
                            "b",
                            [
                              "path",
                              "_.",
                              "_S.b"
                            ]
                          ]
                        ],
                        [
                          "if",
                          [
                            "has-key",
                            "_.",
                            "_S.b"
                          ],
                          [
                            "path",
                            "_.",
                            "_S.b"
                          ],
                          [
                            "path",
                            "_.",
                            "_S.a"
                          ]
                        ]
                      ]
                    ]
                  ],
                  [
                    "distinct",
                    [
                      "combine",
                      [
                        "keys",
                        "_S.a"
                      ],
                      [
                        "keys",
                        "_S.b"
                      ]
                    ]
                  ]
                ]
              ]
            ]
          ],
          "remove-unmapped-properties": [
            [
              "comment",
              "function that builds up the dotted key and checks if one of dotted notations in _based_on_properties starts with this dotted key, recurses if the value is a dict"
            ],
            [
              "merge",
              [
                "dict",
                [
                  "map",
                  [
                    "if",
                    [
                      "or",
                      [
                        "and",
                        [
                          "is-dict",
                          [
                            "last",
                            "_."
                          ]
                        ],
                        [
                          "gt",
                          [
                            "count",
                            [
                              "apply",
                              "remove-unmapped-properties",
                              [
                                "dict",
                                "data",
                                [
                                  "last",
                                  "_."
                                ],
                                "prefix",
                                [
                                  "concat",
                                  "_S.prefix",
                                  [
                                    "ni-id",
                                    [
                                      "ni",
                                      [
                                        "first",
                                        "_."
                                      ]
                                    ]
                                  ],
                                  "."
                                ]
                              ]
                            ]
                          ],
                          0
                        ]
                      ],
                      [
                        "and",
                        [
                          "not",
                          [
                            "is-dict",
                            [
                              "last",
                              "_."
                            ]
                          ]
                        ],
                        [
                          "and",
                          [
                            "is-not-empty",
                            [
                              "last",
                              "_."
                            ]
                          ],
                          [
                            "neq",
                            [
                              "last",
                              "_."
                            ],
                            ""
                          ]
                        ]
                      ]
                    ],
                    [
                      "list",
                      [
                        "if",
                        [
                          "is-not-empty",
                          [
                            "apply",
                            "is-match",
                            [
                              "dict",
                              "pattern",
                              [
                                "concat",
                                "_S.prefix",
                                [
                                  "ni-id",
                                  [
                                    "ni",
                                    [
                                      "first",
                                      "_."
                                    ]
                                  ]
                                ],
                                "*"
                              ]
                            ]
                          ]
                        ],
                        [
                          "ni-id",
                          [
                            "ni",
                            [
                              "first",
                              "_."
                            ]
                          ]
                        ]
                      ],
                      [
                        "if",
                        [
                          "is-dict",
                          [
                            "last",
                            "_."
                          ]
                        ],
                        [
                          "apply",
                          "remove-unmapped-properties",
                          [
                            "dict",
                            "data",
                            [
                              "last",
                              "_."
                            ],
                            "prefix",
                            [
                              "concat",
                              "_S.prefix",
                              [
                                "ni-id",
                                [
                                  "ni",
                                  [
                                    "first",
                                    "_."
                                  ]
                                ]
                              ],
                              "."
                            ]
                          ]
                        ],
                        [
                          "last",
                          "_."
                        ]
                      ]
                    ]
                  ],
                  [
                    "items",
                    "_S.data"
                  ]
                ]
              ]
            ]
          ],
          "trace": [
            [
              "copy",
              "*",
              [
                "list",
                "$trace_*",
                "$source"
              ]
            ]
          ],
          "update": [
            [
              "add",
              "$operation",
              "update"
            ],
            [
              "add",
              "_payload",
              [
                "if",
                [
                  "is-not-null",
                  "_S.$source.$payload"
                ],
                "_S.$source.$payload",
                [
                  "apply",
                  "payload",
                  "_S.$source"
                ]
              ]
            ],
            [
              "add",
              "_lookup",
              [
                "first",
                "_S.response_body"
              ]
            ],
            [
              "add",
              "payload",
              "_T._payload"
            ]
          ]
        },
        "type": "dtl"
      },
      {
        "allowed_status_codes": "100-599",
        "operation": "{{@ datatype @}}-update",
        "replace_entity": false,
        "response_property": "response_body",
        "response_status_property": "response_status",
        "side_effects": true,
        "system": "{{@ system @}}",
        "trigger_on": {
          "key": "$operation",
          "value": "update"
        },
        "type": "rest"
      },
      {
        "allowed_status_codes": "100-599",
        "operation": "{{@ datatype @}}-insert",
        "replace_entity": false,
        "response_property": "response_body",
        "response_status_property": "response_status",
        "side_effects": true,
        "system": "{{@ system @}}",
        "trigger_on": {
          "key": "$operation",
          "value": "insert"
        },
        "type": "rest"
      },
      {
        "allowed_status_codes": "100-599",
        "operation": "{{@ datatype @}}-delete",
        "replace_entity": false,
        "response_property": "response_body",
        "response_status_property": "response_status",
        "side_effects": true,
        "system": "{{@ system @}}",
        "trigger_on": {
          "key": "$operation",
          "value": "delete"
        },
        "type": "rest"
      },
      {
        "rules": {
          "default": [
            [
              "copy",
              [
                "literal",
                "QuoteLineId"
              ]
            ],
            [
              "copy",
              "$source"
            ],
            [
              "copy",
              "$origin"
            ],
            [
              "copy",
              "$replaced"
            ],
            [
              "copy",
              "$trace_*"
            ],
            [
              "add",
              "$last_operation",
              "_S.$operation"
            ],
            [
              "add",
              [
                "concat",
                "$trace_",
                "_S.$operation"
              ],
              [
                "apply",
                "trace",
                "_S."
              ]
            ],
            [
              "comment",
              "Check lookup operation"
            ],
            [
              "if",
              [
                "and",
                [
                  "eq",
                  "_S.$operation",
                  "lookup"
                ],
                [
                  "not",
                  [
                    "in",
                    "_S.response_status",
                    [
                      "list",
                      200
                    ]
                  ]
                ]
              ],
              [
                "add",
                "$error",
                "error-lookup"
              ]
            ],
            [
              "comment",
              "Check insert operation"
            ],
            [
              "if",
              [
                "eq",
                "_S.$operation",
                "insert"
              ],
              [
                "if",
                [
                  "not",
                  [
                    "in",
                    "_S.response_status",
                    [
                      "list",
                      200,
                      201
                    ]
                  ]
                ],
                [
                  "add",
                  "$error",
                  "error-insert"
                ],
                [
                  [
                    "add",
                    "$generated_id",
                    [
                      "first",
                      "_S.response_body.QuoteLineId"
                    ]
                  ],
                  [
                    "if",
                    [
                      "is-null",
                      "_T.$generated_id"
                    ],
                    [
                      "fail!",
                      "Generated primary key not found"
                    ]
                  ]
                ]
              ]
            ],
            [
              "comment",
              "Check update operation"
            ],
            [
              "if",
              [
                "and",
                [
                  "eq",
                  "_S.$operation",
                  "update"
                ],
                [
                  "not",
                  [
                    "in",
                    "_S.response_status",
                    [
                      "list",
                      200,
                      201,
                      204
                    ]
                  ]
                ]
              ],
              [
                "add",
                "$error",
                "error-update"
              ]
            ],
            [
              "comment",
              "Check delete operation"
            ],
            [
              "if",
              [
                "and",
                [
                  "eq",
                  "_S.$operation",
                  "delete"
                ],
                [
                  "not",
                  [
                    "in",
                    "_S.response_status",
                    [
                      "list",
                      200,
                      204
                    ]
                  ]
                ]
              ],
              [
                "add",
                "$error",
                "error-delete"
              ]
            ],
            [
              "add",
              "_previous",
              [
                "apply",
                "previous",
                [
                  "first",
                  [
                    "hops",
                    {
                      "datasets": [
                        "{{@ system @}}-{{@ datatype @}}-share st"
                      ],
                      "track-dependencies": false,
                      "where": [
                        [
                          "eq",
                          "_S._id",
                          "st._id"
                        ]
                      ]
                    }
                  ]
                ]
              ]
            ],
            [
              "if",
              [
                "and",
                [
                  "is-null",
                  "_T.$generated_id"
                ],
                [
                  "is-not-null",
                  "_T._previous.$generated_id"
                ]
              ],
              [
                "add",
                "$generated_id",
                "_T._previous.$generated_id"
              ]
            ],
            [
              "add-if",
              "$previous_success",
              "_T._previous.$success"
            ],
            [
              "if",
              [
                "is-not-null",
                "_T.$error"
              ],
              [
                "add",
                "$success",
                false
              ],
              [
                "if",
                [
                  "matches",
                  "discard-",
                  "_S.$operation"
                ],
                [
                  "add-if",
                  "$success",
                  "_T.$previous_success"
                ],
                [
                  "add",
                  "$success",
                  true
                ]
              ]
            ],
            [
              "comment",
              "If entity is not successfully deleted and it has a $generated_id then we must not delete it"
            ],
            [
              "if",
              [
                "and",
                [
                  "is-not-null",
                  "_T.$generated_id"
                ],
                [
                  "not",
                  [
                    "and",
                    [
                      "eq",
                      "_S.$operation",
                      "delete"
                    ],
                    [
                      "eq",
                      "_T.$success",
                      true
                    ]
                  ]
                ]
              ],
              [
                "add",
                "_deleted",
                false
              ]
            ],
            [
              "if",
              [
                "eq",
                "_S.$replaced",
                true
              ],
              [
                "add-if",
                "$origin",
                "_T._previous.$origin"
              ]
            ]
          ],
          "previous": [
            [
              "copy",
              "$generated_id"
            ],
            [
              "copy",
              "$origin"
            ],
            [
              "copy",
              "$success"
            ]
          ],
          "trace": [
            [
              "copy",
              "*",
              [
                "list",
                "$trace_*",
                "$source"
              ]
            ]
          ]
        },
        "type": "dtl"
      }
    ],
    "type": "pipe"
  }
]
